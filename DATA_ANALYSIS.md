# Tomocube Data Layout and Format Reference

This document describes the general Tomocube data/package layout and file formats consumed by `tomocube-tools`.
It is intentionally dataset-agnostic and should be used as a format reference, not a snapshot of one specific experiment.

## Scope

Applies to common Tomocube acquisitions that include:

- TCF volumes (`.TCF`, HDF5 container)
- sidecar metadata files (`.experiment`, `.vessel`, `.prf`, `config.dat`, `.tcxexp`, `.tcxpro`, `.parent`)
- derived media exports (PNG, GIF, MP4, TIFF, MAT) generated by tools

## Typical Directory Pattern

```text
<project_root>/
  <project>.tcxpro
  <experiment>/
    <experiment>.tcxexp
    Cell.img.prf
    Cell.prc.ht.prf
    Cell.prc.fl.prf
    Cell.psf.prf
    <session_1>/
      <session_name>.TCF
      config.dat
      .experiment
      .vessel
      .parent
      bgImages/
      profile/
      thumbnail/
    <session_2>/
      ...
```

Actual naming and folder depth can vary by acquisition software version and lab conventions.

## Primary File: `.TCF` (HDF5)

TCF files are HDF5 containers with HT data and optional FL data.

### Core Paths

```text
Data/
  3D/<timepoint>                 # HT volume, shape (Z, Y, X)
  2DMIP/<timepoint>              # optional MIP
  3DFL/<channel>/<timepoint>     # optional FL channels

Info/
  Device                         # optics/device attributes
  MetaData/...                   # embedded raw metadata
```

### Common Attributes

| Location | Attributes |
|---|---|
| `Data/3D` | `ResolutionX`, `ResolutionY`, `ResolutionZ` (HT voxel size, um) |
| `Data/3DFL` | `ResolutionX`, `ResolutionY`, `ResolutionZ` (FL voxel size, um) |
| `Data/3DFL/<channel>` | `OffsetZ` (FL offset in HT coordinate system) |
| root attrs (optional) | `DeviceModelType`, `DeviceSerial`, `SoftwareVersion` |

### Data Conventions

- Volumes are indexed `(Z, Y, X)`.
- HT values may be stored scaled (for example integer-like RI values). `TCFFileLoader` converts to physical RI units.
- FL channels are often named `CH0`, `CH1`, etc.
- Timepoint keys are usually string indices like `000000`.

## Sidecar Metadata Formats

### `.experiment` / `.tcxexp`

- Format: JSON
- Typically contains experiment-level configuration, medium info, sample type, and acquisition settings.

### `.vessel`

- Format: JSON
- Contains vessel/well geometry and layout metadata.

### `.prf` (profiles)

- Format: INI-like key/value text
- Contains imaging and processing profile parameters.

### `config.dat`

- Format: INI-like key/value text
- Contains per-session acquisition/device settings.

### `.tcxpro`

- Format: JSON
- Project-level metadata (project title/description).

### `.parent`

- Format: plain text
- Pointer/reference to parent project or experiment path.

## Relationships and Usage in `tomocube-tools`

- `TCFFile` / `TCFFileLoader` consume `.TCF` data and core metadata.
- `discover_related_metadata(...)` searches sidecars relative to the TCF session directory: `.vessel`, `.experiment`, and `profile/*.prf`.
- `register_fl_to_ht(...)` aligns FL into HT coordinates for 2D overlays/exports.
- `view3d` uses native FL resolution and physical `scale`/`translate` in napari (no FL resampling to HT grid).

## Instrument Defaults

If resolution attributes are missing, defaults are selected by model lookup in `src/tomocube/core/constants.py` (`INSTRUMENT_DEFAULTS`), with a fallback default profile.

Configured model keys currently include:

- `HTX`
- `HT-2H-60x`
- `HT-2H-40x`
- `default`

## Format Validation Checklist

For a new dataset, verify:

1. `.TCF` opens as HDF5.
2. `Data/3D/<timepoint>` exists and has non-empty `(Z, Y, X)` shape.
3. Resolution attributes exist or default fallback behavior is acceptable.
4. If FL is expected, `Data/3DFL/<channel>/<timepoint>` exists.
5. `OffsetZ` values are present/reasonable for FL channels when registration accuracy matters.
6. Sidecar files parse as expected (JSON/INI/plain text).

## Minimal Programmatic Checks

```python
import h5py
from tomocube import TCFFile, TCFFileLoader

with h5py.File("path/to/file.TCF", "r") as f:
    meta = TCFFile.from_hdf5(f)
    print(meta.ht_shape, meta.ht_resolution, meta.fl_channels)

with TCFFileLoader("path/to/file.TCF") as loader:
    loader.load_timepoint(0)
    print(loader.data_3d.shape, loader.has_fluorescence)
```
